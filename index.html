<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Grupos WhatsApp</title>
<meta property="og:title" content="Grifinória ?">
<meta property="og:description" content="Convite para conversar em grupo">
<meta property="og:image" content="https://files.catbox.moe/ls07y5.jpg">
<meta property="og:url" content="https://saniofc.github.io/griffinoria/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<style>
/* ... seu CSS aqui ... */
</style>
</head>
<body>
<video id="video-bg" autoplay muted loop playsinline>
  <source src="https://files.catbox.moe/dymzif.mp4" type="video/mp4">
</video>

<header>
  <h1>Grupos WhatsApp</h1>
  <p></p>
  <p id="contador">Visitas: 0</p>
  <div id="categorias">
    <button class="cat-btn active" data-cat="Todos">Todos</button>
    <button class="cat-btn" data-cat="amizade">Amizade</button>
    <button class="cat-btn" data-cat="zoeira">Zoeira</button>
    <button class="cat-btn" data-cat="namoro">Namoro</button>
  </div>
</header>

<div class="menu-icon" id="menuBtn">📝</div>
<div class="menu" id="sideMenu">
  <button class="close-btn" id="closeBtn">❌</button>
  <h2>Informações</h2>
  <a href="https://br.shp.ee/1r878lx?smtt=0.0.9" target="_blank">🛍️Loja da Miih</a>
  <a href="https://wa.me//5521977231625" target="_blank">🤖Alugar bot</a>
  <a href="#" id="meusGrupos">📋Meus Grupos</a>
  <a href="#" id="enviarGrupo">📨Enviar Meu Grupo</a>
  <a href="https://wa.me//5521977231625" target="_blank">💎Comprar bot</a>
</div>

<div id="lista-grupos"></div>
<a class="botao" href="https://linkfly.to/grifinoria" target="_blank">Outros Grupos</a>

<!-- Modal -->
<div class="modal">
  <div class="modal-content">
    <span class="close-modal">×</span>
    <h3>Enviar / Editar Grupo</h3>
    <input type="text" id="grupoNome" placeholder="Nome do Grupo">
    <input type="text" id="grupoLink" placeholder="Link do Grupo">
    <input type="text" id="grupoFoto" placeholder="URL da Foto">
    <input type="text" id="grupoCategoria" placeholder="Categoria">
    <input type="text" id="grupoVipCodigo" placeholder="Código VIP (opcional)">
    <button id="salvarGrupo">Salvar</button>
    <button id="comprarVip">Comprar Código VIP</button>
  </div>
</div>

<footer>
  Blog · Termos de Uso · Política de Privacidade · FAQ<br>
  ? COPYRIGHT 2025 - <a href="https://saniofc.github.io/griffinoria/" target="_blank">saniofc.github.io/griffinoria/</a>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, set, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDsrYjO2yVTemKqwmJRzNjh5sfaMalPqhE",
  authDomain: "cliques-4a2c1.firebaseapp.com",
  databaseURL: "https://cliques-4a2c1-default-rtdb.firebaseio.com",
  projectId: "cliques-4a2c1",
  storageBucket: "cliques-4a2c1.firebasestorage.app",
  messagingSenderId: "903875153255",
  appId: "1:903875153255:web:ff3cf25e059b10d665b3c2",
  measurementId: "G-BQHZ7FWRJD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const menu = document.getElementById('sideMenu');
document.getElementById('menuBtn').addEventListener('click',()=>menu.classList.add('open'));
document.getElementById('closeBtn').addEventListener('click',()=>menu.classList.remove('open'));

let todosGrupos = [];

const modal = document.querySelector('.modal');
const modalContent = modal.querySelector('.modal-content');
const meusBtn = document.getElementById('meusGrupos');
const enviarBtn = document.getElementById('enviarGrupo');
const salvarBtn = document.getElementById('salvarGrupo');
const vipBtn = document.getElementById('comprarVip');
const usuario = localStorage.getItem('usuarioID');

modal.querySelector('.close-modal').onclick = () => modal.style.display = 'none';

async function carregarGrupos() {
  let jsonGrupos = [];
  try { jsonGrupos = await (await fetch('grupos.json')).json(); } 
  catch(e){ console.warn('Nenhum grupos.json encontrado ou erro ao carregar:', e); }

  const gruposRef = ref(db, 'grupos');
  onValue(gruposRef, snap => {
    const dadosFirebase = snap.val() ? Object.values(snap.val()) : [];
    const enviadosLocais = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
    const mapa = new Map();
    [...jsonGrupos,...dadosFirebase,...enviadosLocais].forEach(g=>{
      if(g?.nome){ g.vip = !!g.vip; mapa.set(g.nome.toLowerCase(),g);}
    });
    todosGrupos = Array.from(mapa.values());
    renderizarGrupos(todosGrupos);
  });
}

function renderizarGrupos(lista){
  const container = document.getElementById('lista-grupos');
  container.innerHTML = '';
  if(lista.length===0){ container.innerHTML='<p style="color:#ccc;">Nenhum grupo encontrado.</p>'; return; }
  lista.sort((a,b)=>a.vip&&!b.vip?-1:!a.vip&&b.vip?1:0);
  lista.forEach(g=>{
    const wrapper=document.createElement('div'); wrapper.style.display='flex'; wrapper.style.flexDirection='column'; wrapper.style.alignItems='center'; wrapper.style.width='100%';
    const btn=document.createElement('a'); btn.className='grupo'+(g.vip?' vip':''); btn.href=g.link; btn.target='_blank';
    btn.innerHTML=`<img class="foto" src="${g.foto}" alt="foto do grupo">
      <div class="info">
        <span class="nome">${g.nome}</span>
        <div class="categoria">${g.categoria||''}</div>
        <div class="cliques" style="position:absolute;top:6px;right:14px;font-size:12px;color:#ffd700;">0</div>
      </div>`;
    const cliqueRef = ref(db,'cliques/'+g.nome);
    onValue(cliqueRef,snap=>{ btn.querySelector('.cliques').textContent=`Cliques: ${snap.val()||0}`; });
    btn.addEventListener('click',e=>{ e.preventDefault(); runTransaction(cliqueRef,c=>(c||0)+1).then(()=>window.open(g.link,'_blank')); });
    wrapper.appendChild(btn);

    if(g.dono===usuario){
      const box=document.createElement('div'); box.style.display='flex'; box.style.gap='6px'; box.style.marginTop='8px';
      const edit=document.createElement('button'); edit.textContent='Editar'; edit.style.cssText='padding:4px 10px;font-size:12px;border-radius:8px;cursor:pointer;background:#b78cff;color:#fff;';
      edit.onclick=()=>abrirEdicao(g);
      const del=document.createElement('button'); del.textContent='Excluir'; del.style.cssText='padding:4px 10px;font-size:12px;border-radius:8px;cursor:pointer;background:#ff4d4d;color:#fff;';
      del.onclick=()=>excluirGrupo(g);
      box.appendChild(edit); box.appendChild(del); wrapper.appendChild(box);
    }
    container.appendChild(wrapper);
  });
}

// EDIÇÃO / ENVIO
meusBtn.onclick=()=>{ const meus = todosGrupos.filter(g=>g.dono===usuario); renderizarGrupos(meus.length?meus:[]); };
enviarBtn.onclick=()=>{ modal.style.display='flex'; salvarBtn.onclick=null; };

vipBtn.onclick=()=>{
  const pix="SEU_PIX_AQUI";
  const codigoVip=crypto.randomUUID().slice(0,8);
  alert(`💰 Para comprar o código VIP, envie PIX para:\n\n${pix}\nApós, confirme.`);
  if(confirm("Confirmou o pagamento?")){ document.getElementById('grupoVipCodigo').value=codigoVip; alert(`✅ Código VIP: ${codigoVip}`); }
};

function abrirEdicao(g){
  modal.style.display='flex';
  document.getElementById('grupoNome').value=g.nome;
  document.getElementById('grupoLink').value=g.link;
  document.getElementById('grupoFoto').value=g.foto;
  document.getElementById('grupoCategoria').value=g.categoria;
  document.getElementById('grupoVipCodigo').value=g.vip?"htmly":"";
  const nomeOriginal=g.nome;
  salvarBtn.onclick=()=>salvarEdicao(g,nomeOriginal);
}

async function salvarEdicao(g,nomeOriginal){
  g.nome=document.getElementById('grupoNome').value.trim();
  g.link=document.getElementById('grupoLink').value.trim();
  g.foto=document.getElementById('grupoFoto').value.trim()||'https://files.catbox.moe/ls07y5.jpg';
  g.categoria=document.getElementById('grupoCategoria').value;
  g.vip=document.getElementById('grupoVipCodigo').value.trim()!=""?true:false;
  if(nomeOriginal!==g.nome) await remove(ref(db,'grupos/'+nomeOriginal));
  await set(ref(db,'grupos/'+g.nome),g);
  let enviados=JSON.parse(localStorage.getItem('gruposEnviados')||'[]');
  enviados=enviados.map(x=>x.nome===nomeOriginal?g:x); localStorage.setItem('gruposEnviados',JSON.stringify(enviados));
  modal.style.display='none';
  renderizarGrupos(todosGrupos.filter(x=>x.dono===usuario));
}

function excluirGrupo(g){
  if(!confirm('Deseja realmente excluir este grupo?')) return;
  remove(ref(db,'grupos/'+g.nome));
  todosGrupos=todosGrupos.filter(x=>x.nome!==g.nome);
  let enviados=JSON.parse(localStorage.getItem('gruposEnviados')||'[]');
  enviados=enviados.filter(x=>x.nome!==g.nome); localStorage.setItem('gruposEnviados',JSON.stringify(enviados));
  renderizarGrupos(todosGrupos.filter(x=>x.dono===usuario));
}

// ================== SALVAR NOVO GRUPO ================== //
document.getElementById('salvarGrupo').onclick = async () => {
  const nome = document.getElementById('grupoNome').value.trim();
  const link = document.getElementById('grupoLink').value.trim();
  const foto = document.getElementById('grupoFoto').value.trim() || 'https://files.catbox.moe/ls07y5.jpg';
  const categoria = document.getElementById('grupoCategoria').value;
  const vipCodigo = document.getElementById('grupoVipCodigo').value.trim();

  if (!nome || !link.startsWith('https://chat.whatsapp.com/')) {
    alert('Preencha corretamente o nome e o link do grupo!');
    return;
  }

  const isVip = vipCodigo === "htmly";
  const usuario = localStorage.getItem('usuarioID') || crypto.randomUUID();
  localStorage.setItem('usuarioID', usuario);

  const novoGrupo = { nome, link, foto, categoria, dono: usuario, vip: isVip };

  if (todosGrupos.some(g => g.nome.toLowerCase() === nome.toLowerCase())) {
    alert('Já existe um grupo com esse nome. Escolha outro.');
    return;
  }

  await set(ref(db, 'grupos/' + nome), novoGrupo);

  todosGrupos.push(novoGrupo);
  let enviados = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
  enviados.push(novoGrupo);
  localStorage.setItem('gruposEnviados', JSON.stringify(enviados));

  // Renderiza apenas os grupos do usuário
  renderizarGrupos(todosGrupos.filter(g => g.dono === usuario));
  modal.style.display = 'none';
  alert('✅ Grupo enviado com sucesso!');
};

// ================== MEUS GRUPOS ================== //
meusBtn.onclick = () => {
  const usuario = localStorage.getItem('usuarioID');
  if (!usuario) return alert('Você ainda não enviou nenhum grupo.');
  const meus = todosGrupos.filter(g => g.dono === usuario);
  if (meus.length === 0) alert('Você ainda não enviou nenhum grupo.');
  else renderizarGrupos(meus);
};

// ================== INICIAR ================== //
carregarGrupos();
</script>
</body>
</html>
