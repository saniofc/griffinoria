<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Grupos WhatsApp Grátis - Link de Amizade, Zoeira e Namoro</title>
<meta name="description" content="Encontre os melhores Grupos WhatsApp de Zoeira, Amizade, Namoro e muito mais. Links de convite grátis, atualizados e verificados. Participe!">
<link rel="canonical" href="https://saniofc.github.io/griffinoria/">

<meta property="og:title" content="Grupos whatsapp⭐">
<meta property="og:description" content="Convite para conversar em grupo">
<meta property="og:image" content="https://i.postimg.cc/hvgGzhXs/2bcdefad5d298a05f930aa96e6fbc34a.jpg">
<meta property="og:url" content="https://saniofc.github.io/griffinoria/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">

<style>
/* Reset e Estilos Básicos */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,sans-serif;color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding-top:120px;background:#000}
#video-bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1;filter:brightness(0.4)}

/* --- Header e Categorias --- */
header{position:fixed;top:0;left:0;width:100%;padding:12px 10px;background:rgba(0,0,0,0.6);text-align:center;z-index:1000}
header h1{font-size:28px;text-shadow:2px 2px 5px #000}
header p{margin-top:4px;text-shadow:1px 1px 3px #000}
#contador{margin-top:4px;color:#ffd700;text-shadow:1px 1px 2px #000;font-size:15px}
#categorias{margin-top:8px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap}
.cat-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:20px;color:#fff;font-size:13px;padding:5px 11px;cursor:pointer;transition:all .2s}
.cat-btn:hover{background:rgba(255,255,255,0.25)}
.cat-btn.active{background:#b78cff;border-color:#b78cff}

/* --- Menu Lateral (Ícone Hambúrguer) --- */
.menu-icon{position:fixed;top:20px;right:20px;font-size:28px;z-index:1100;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:10px;cursor:pointer; line-height: 1;} /* Ajuste de line-height para o ícone */
.menu{position:fixed;top:0;right:-300px;width:250px;height:100%;background:rgba(0,0,0,0.9);padding:30px 20px;transition:right .3s;z-index:1200}
.menu.open{right:0}
.menu .close-btn{position:absolute;top:15px;right:20px;background:none;border:none;color:#fff;font-size:26px;cursor:pointer}
.menu h2{margin-top:50px;color:#b78cff;border-bottom:1px solid #b78cff;padding-bottom:5px;text-align:left}
.menu a{display:block;text-decoration:none;color:#fff;background:rgba(183,140,255,0.12);padding:12px;border-radius:10px;margin-top:15px;text-align:left;font-size:18px}
.menu a:hover{background:rgba(183,140,255,0.25)}

/* --- Lista de Grupos (Estilo NOVO - Como no Print) --- */
#lista-grupos{width:100%;max-width:420px;padding:30px 20px 60px;display:flex;flex-direction:column;align-items:center;gap:22px}

/* Aprimoramento do Cartão do Grupo (Baseado no Print) */
.grupo{
    width:100%;
    max-width:380px;
    display:flex;
    align-items:center;
    gap:14px;
    /* Fundo mais claro e arredondado */
    background:rgba(255,255,255,0.05);
    padding:16px 20px;
    border-radius:25px; 
    text-decoration:none;
    color:#fff;
    position:relative;
    transition:transform .18s,background .18s,box-shadow .18s;
    border:none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.grupo:hover{transform:scale(1.02);background:rgba(255,255,255,0.12); box-shadow: 0 6px 15px rgba(0,0,0,0.6);}

/* Ajuste na Imagem */
.grupo img.foto{
    width:50px;
    height:50px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid rgba(255,255,255,0.2);
}
/* Estilo do Texto */
.grupo .info{display:flex;flex-direction:column;align-items:flex-start;justify-content:center;text-align:left}
.grupo span.nome{font-size:18px;font-weight:bold;line-height:1.2; text-shadow: 0 0 3px #000;}
.grupo .categoria{font-size:13px;color:#ccc;margin-top:2px; padding: 2px 8px; border-radius: 10px; background: rgba(183,140,255, 0.2); text-transform: capitalize;}

/* Estilo VIP (Estrela e Fundo Dourado - NOVO) */
.grupo.vip{
    /* Fundo com gradiente sutil para destaque */
    background: linear-gradient(90deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05));
    border:1px solid rgba(255,215,0,0.35);
    box-shadow: 0 0 10px 4px rgba(255,215,0,0.2), 0 4px 12px rgba(0,0,0,0.5);
}
/* Estrela no Canto Superior Esquerdo */
.grupo.vip::before{
    content:"⭐";
    position:absolute;
    left:10px; /* Posicionamento dentro da caixa */
    top:10px;
    transform: none;
    font-size:18px; 
    color:#ffd700;
    text-shadow:0 0 8px #ffda00,0 0 12px #ffb700;
    animation:none;
}
.grupo.vip .categoria{color: #ffd700; background: rgba(255,215,0,0.2);}

/* NOVO: Estilos para Botões de Ação (Editar/Excluir) */
.grupo-acoes-wrapper { /* Classe para o wrapper onde ficam os botões */
    display: flex; 
    gap: 8px; 
    margin-top: 10px; 
    width: 100%;
    justify-content: center; /* Centraliza as ações */
}
.grupo-acoes-wrapper button {
    border: none;
    padding: 6px 15px;
    border-radius: 20px; /* Borda mais arredondada como no print */
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: background 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.grupo-acoes-wrapper button:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
/* Estilo Específico para o botão Editar */
.grupo-acoes-wrapper button.edit-btn {
    background: rgba(46, 204, 113, 0.8); /* Verde suave */
    color: #fff;
}
.grupo-acoes-wrapper button.edit-btn:hover {
    background: rgba(46, 204, 113, 1);
}
/* Estilo Específico para o botão Excluir */
.grupo-acoes-wrapper button.delete-btn {
    background: rgba(231, 76, 60, 0.8); /* Vermelho suave */
    color: #fff;
}
.grupo-acoes-wrapper button.delete-btn:hover {
    background: rgba(231, 76, 60, 1);
}

/* Ajuste no estilo dos cliques */
.grupo .cliques {
    position: absolute;
    top: 10px; 
    right: 20px;
    font-size: 13px;
    color: #ffd700;
    text-shadow: 0 0 4px rgba(0,0,0,0.8);
}

/* Botão de Renda Extra */
.botao{background:rgba(0,0,0,0.7);color:#fff;border:2px solid #fff;border-radius:30px;padding:12px 28px;margin-top:20px;text-decoration:none;font-size:18px;transition:transform .18s,box-shadow .18s;display:inline-block}
.botao:hover{transform:scale(1.04)}

/* Footer - Fundo Transparente */
footer{position:fixed;bottom:0;left:0;width:100%;background:rgba(0,0,0,0.0);color:#ccc;text-align:center;padding:14px 10px;font-size:14px;line-height:1.6;z-index:2000;text-shadow: 1px 1px 3px #000;}
footer a{color:#b78cff;text-decoration:none}

/* Modal Geral e Termos (MANTIDOS) */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:5000}
.modal-content{background:#111;padding:20px;border-radius:20px;max-width:400px;width:90%;text-align:center;color:#fff;position:relative}
.modal-content h3{margin-bottom:15px}
.modal-content input, .modal-content select{width:90%;margin:5px 0;padding:8px;border-radius:10px;border:none;background:#222;color:#fff;}
.modal-content button{padding:10px 20px;margin-top:10px;border:none;border-radius:15px;background:#b78cff;color:#fff;cursor:pointer;transition:0.2s}
.modal-content button:hover{background:#a56be0}
.modal .close-modal{position:absolute;top:10px;right:15px;font-size:22px;cursor:pointer}

/* Estilo para o conteúdo do Modal VIP (MANTIDO) */
#vipModal > .modal-content {
    animation: fadeZoom 0.25s ease;
    border: 1px solid gold;
    padding: 25px;
    max-width: 350px;
    max-width: 90%; 
    width: 380px; 
}

/* Estilo específico para o botão de Copiar e Enviar Comprovante (MANTIDO) */
.pix-copy-btn {
    background: #00bfff; /* Cor do Pix */
    color: #fff;
    font-weight: bold;
    margin-top: 15px;
    padding: 12px 25px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
}
.pix-copy-btn:hover {
    background: #0099cc;
}

.whatsapp-btn {
    background: #25d366; /* Cor do WhatsApp */
    color: #fff;
    font-weight: bold;
    margin-top: 15px;
    padding: 12px 25px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: block;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
    transition: background 0.2s;
}
.whatsapp-btn:hover {
    background: #1eaa54;
}

/* NOVO ESTILO PARA O FORMULÁRIO DE ENVIO (MANTIDO) */
#modalEnvioGrupo .modal-content {
    background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
    border: 1px solid #b78cff;
    padding: 30px;
}
#modalEnvioGrupo h3 {
    color: #b78cff;
    border-bottom: 2px solid #b78cff;
    padding-bottom: 10px;
}
#modalEnvioGrupo .modal-content input,
#modalEnvioGrupo .modal-content select {
    background: #222;
    color: #fff;
    border: 1px solid #444;
    transition: border-color 0.2s;
}
#modalEnvioGrupo .modal-content input:focus,
#modalEnvioGrupo .modal-content select:focus {
    border-color: #b78cff;
    outline: none;
}
#grupoFotoLabel {
    display: block;
    background: #555;
    color: #fff;
    padding: 10px;
    border-radius: 10px;
    cursor: pointer;
    margin: 10px auto;
    width: 90%;
    transition: background 0.2s;
}
#grupoFotoLabel:hover {
    background: #777;
}
#grupoFotoUpload {
    display: none; /* Esconde o input file original */
}
#previewContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 15px;
}
#previewFoto {
    width: 80px;
    height: 80px;
    border: 3px solid #b78cff;
    box-shadow: 0 0 10px rgba(183,140,255,0.5);
}
#modalEnvioGrupo #salvarGrupo {
    background: #2ecc71;
    font-size: 16px;
}
#modalEnvioGrupo #salvarGrupo:hover {
    background: #27ae60;
}
</style>
</head>
<body>
<video id="video-bg" autoplay muted loop playsinline>
  <source src="https://files.catbox.moe/dymzif.mp4" type="video/mp4">
</video>

<header>
  <h1>Grupos WhatsApp</h1>
  <p></p>
  <p id="contador">Visitas: 0</p>
  <div id="categorias">
    <button class="cat-btn active" data-cat="Todos">Todos</button>
    <button class="cat-btn" data-cat="amizade">Amizade</button>
    <button class="cat-btn" data-cat="zoeira">Zoeira</button>
    <button class="cat-btn" data-cat="namoro">Namoro</button>
  </div>
</header>
<div class="menu-icon" id="menuBtn">☰</div> <div class="menu" id="sideMenu">
  <button class="close-btn" id="closeBtn">❌</button>
  <h2>informações</h2>
  <a href="https://br.shp.ee/1r878lx?smtt=0.0.9" target="_blank">🛍️ Loja</a>
  <a href="#" id="meusGrupos">📝 Meus Grupos</a>
  <a href="#" id="enviarGrupo">🚀 Enviar Meu Grupo</a>
  <a href="https://linkfly.to/grifinoria" target="_blank">Renda extra👨‍💻💰</a> <a href="#" id="comprarVipBtn">⭐ Comprar VIP</a>
</div>

<div id="lista-grupos"></div>
<div id="modalTermos" class="modal">
  <div class="modal-content">
    <span class="close-modal">❌</span>
    <h3 id="modalTitulo"></h3>
    <div id="modalTexto" style="text-align:left; max-height:300px; overflow-y:auto;"></div>
  </div>
</div>

<div id="vipModal" class="modal">
  <div class="modal-content" id="vip-content-container">
    <span class="close-modal" id="fecharVipIcon">❌</span>
    <h3>⭐ Ativar VIP (Pagamento Pix) ⭐</h3>
    
    <p style="margin-bottom: 10px;">Grupos VIPs serão mais visíveis e terão mais visitas!</p>
    
    <div style="margin: 15px 0;">
        <img id="qrcode-img" 
             src="https://files.catbox.moe/kvyq5d.jpg" 
             alt="QR Code Pix" 
             style="width: 90%; max-width: 300px; border: 2px solid gold; border-radius: 10px;">
    </div>

    <input type="text" id="pix-code-field" 
           value="00020126580014BR.GOV.BCB.PIX013689a5c070-cdd1-443b-997d-0cbbcf80e2de52040000530398654045.005802BR5918Elias da Conceicao6009SAO PAULO62140510lRM9nLzEht6304AA83" 
           style="position: absolute; left: -9999px;">
           
    <button id="copy-pix-btn" class="pix-copy-btn">
        📋 Copiar Código Pix
    </button>
    
    <p style="margin-top: 15px; font-size: 14px; color: #ccc;">
        Após pagar, envie o comprovante:
    </p>

    <a href="https://wa.me/5521977231625?text=Ol%C3%A1%2C%20acabei%20de%20fazer%20o%20Pix%20para%20o%20VIP.%20Segue%20o%20comprovante!" 
       target="_blank" 
       class="whatsapp-btn">
       Enviar Comprovante (WhatsApp) 📱
    </a>

    <button id="fecharVipBtn"
            style="background:#e74c3c; color:#fff; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; margin-top: 20px;">
      Fechar
    </button>
  </div>
</div>
<div id="modalAvisoVip" class="modal">
  <div class="modal-content">
    <span class="close-modal" id="fecharAvisoVip">❌</span>
    <h3 id="avisoVipTitulo"></h3>
    <p id="avisoVipMensagem"></p>
    <p id="avisoVipCodigo" style="font-size:24px; font-weight:bold; color:#ffd700; margin-top:15px;"></p>
  </div>
</div>

<div id="modalEnvioGrupo" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="document.getElementById('modalEnvioGrupo').style.display = 'none';" style="position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer;">❌</span>
    <h3>Enviar Meu Grupo</h3>
    
    <input type="text" id="grupoNome" placeholder=" Nome do grupo" required>
    <input type="text" id="grupoLink" placeholder=" Link do grupo (https://chat.whatsapp.com/...)" required>
    
    <select id="grupoCategoria" required>
      <option value=""> Selecione a Categoria</option>
      <option value="Amizade">Amizade</option>
      <option value="Zoeira">Zoeira</option>
      <option value="Namoro">Namoro</option>
    </select>
    
    <input type="text" id="grupoVipCodigo" placeholder=" Código VIP (opcional)">

    <div id="previewContainer">
        <input type="file" id="grupoFotoUpload" accept="image/*">
        <label for="grupoFotoUpload" id="grupoFotoLabel"> Escolha a foto do grupo</label>
        
        <img id="previewFoto" src="https://files.catbox.moe/ls07y5.jpg" alt="Prévia da foto">
    </div>
    
    <button id="salvarGrupo">
      Enviar Grupo
    </button>
    <p id="mensagemEnvio" style="margin-top:10px; color:#2ecc71; font-weight:bold; display:none;">Grupo enviado com sucesso!</p>
  </div>
</div>

<footer>
  <a href="#" id="termosLink">Termos de Uso</a>
  <a href="#" id="privacidadeLink">Politica de Privacidade</a><br>
  © COPYRIGHT 2025 - <a href="https://saniofc.github.io/griffinoria/" target="_blank">saniofc.github.io/griffinoria/</a>
</footer>

<script type="module">
// Versões mais recentes e modulares do Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Credenciais do Firebase (MANTIDAS)
const firebaseConfig = {
  apiKey: "AIzaSyDsrYjO2yVTemKqwmJRzNjh5sfaMalPqhE",
  authDomain: "cliques-4a2c1.firebaseapp.com",
  databaseURL: "https://cliques-4a2c1-default-rtdb.firebaseio.com",
  projectId: "cliques-4a2c1",
  storageBucket: "cliques-4a2c1.firebasestorage.app",
  messagingSenderId: "903875153255",
  appId: "1:903875153255:web:ff3cf25e059b10d665b3c2",
  measurementId: "G-BQ7FWRJD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Variáveis de Elementos (MANTIDAS)
const menu = document.getElementById('sideMenu');
const enviarBtn = document.getElementById('enviarGrupo');
const meusBtn = document.getElementById('meusGrupos');
const contador = document.getElementById('contador');
const modalTermos = document.getElementById('modalTermos');
const closeModalTermos = modalTermos.querySelector('.close-modal');
const modalTitulo = document.getElementById('modalTitulo');
const modalTexto = document.getElementById('modalTexto');

const vipModal = document.getElementById('vipModal');
const fecharVipIcon = document.getElementById('fecharVipIcon');
const fecharVipBtn = document.getElementById('fecharVipBtn');

const modalAvisoVip = document.getElementById('modalAvisoVip');
const avisoVipTitulo = document.getElementById('avisoVipTitulo');
const avisoVipMensagem = document.getElementById('avisoVipMensagem');
const avisoVipCodigo = document.getElementById('avisoVipCodigo');
document.getElementById('fecharAvisoVip').onclick = () => modalAvisoVip.style.display = 'none';

// Elementos Pix
const pixCodeField = document.getElementById('pix-code-field');
const copyPixBtn = document.getElementById('copy-pix-btn');


let todosGrupos = [];

// REGEX CORRIGIDO
const WHATSAPP_LINK_REGEX = /^https?:\/\/(chat\.)?whatsapp\.com\/(invite\/)?[A-Za-z0-9]{22}(\?.*)?$/;


// ================== CRIAÇÃO E MANIPULAÇÃO DO MODAL DE GRUPO (MANTIDO) ================== //

const modal = document.getElementById('modalEnvioGrupo'); 
const previewFoto = document.getElementById("previewFoto");
const fotoInput = document.getElementById("grupoFotoUpload");
const salvarGrupoBtn = document.getElementById('salvarGrupo');

salvarGrupoBtn.addEventListener('mouseover', () => salvarGrupoBtn.style.background = '#27ae60');
salvarGrupoBtn.addEventListener('mouseout', () => salvarGrupoBtn.style.background = '#2ecc71');

fotoInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (ev) => (previewFoto.src = ev.target.result);
    reader.readAsDataURL(file);
  }
});

// ================== SALVAR NOVO GRUPO ================== //
async function salvarNovoGrupo() {
  const nome = document.getElementById('grupoNome').value.trim();
  const link = document.getElementById('grupoLink').value.trim();
  const foto = previewFoto.src.trim() || 'https://files.catbox.moe/ls07y5.jpg';
  const categoria = document.getElementById('grupoCategoria').value;
  const vipCodigo = document.getElementById('grupoVipCodigo').value.trim();

  // Validação CORRIGIDA usando o novo Regex
  if (!nome) {
    alert('O nome do grupo é obrigatório.');
    return;
  }
  if (!WHATSAPP_LINK_REGEX.test(link)) {
    alert('Por favor, use um link de convite do WhatsApp válido (ex: https://chat.whatsapp.com/...).');
    return;
  }
  if (!categoria) {
    alert('A categoria do grupo é obrigatória. Por favor, escolha uma.');
    return;
  }
  
  // Validação: Link repetido (CONFORME SOLICITADO)
  const linkExiste = todosGrupos.some(g => g.link === link);
  if (linkExiste) {
      alert('Já existe um grupo com esse link. Use um link que ainda não está cadastrado.');
      return;
  }
  
  // O nome é usado como chave no Firebase, então tem que ser único
  const nomeExiste = todosGrupos.some(g => g.nome.toLowerCase() === nome.toLowerCase());
  if (nomeExiste) {
      alert('Já existe um grupo com esse nome. Por favor, escolha outro nome.');
      return;
  }
  
  // Gera ID de usuário se não existir (MANTIDO)
  const isVip = vipCodigo === "∜"; 
  const usuario = localStorage.getItem('usuarioID') || crypto.randomUUID();
  localStorage.setItem('usuarioID', usuario);

  const novoGrupo = { nome, link, foto, categoria, dono: usuario, vip: isVip };

  // Salva no Firebase
  await set(ref(db, 'grupos/' + nome), novoGrupo);

  const msg = document.getElementById('mensagemEnvio');
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 3000);

  // Salva localmente para rastreio
  let enviados = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
  enviados.push(novoGrupo);
  localStorage.setItem('gruposEnviados', JSON.stringify(enviados));
  
  carregarGrupos(); 
  modal.style.display = 'none';
};

// SALVAR GRUPO AGORA APONTA PARA A FUNÇÃO DE NOVO GRUPO POR PADRÃO
// ELA SERÁ SOBRESCRITA PELA FUNÇÃO DE EDIÇÃO QUANDO NECESSÁRIO
salvarGrupoBtn.onclick = salvarNovoGrupo;

// ================== FUNÇÕES DE EDIÇÃO/EXCLUSÃO, CARREGAR GRUPOS ================== //

function abrirEdicao(grupo){
  modal.style.display = 'flex';
  document.getElementById('grupoNome').value = grupo.nome;
  document.getElementById('grupoLink').value = grupo.link;
  previewFoto.src = grupo.foto;
  document.getElementById('grupoCategoria').value = grupo.categoria;
  document.getElementById('grupoVipCodigo').value = grupo.vip ? "∜" : "";
  
  const nomeOriginal = grupo.nome; 
  
  // Define a função de salvar para a edição
  salvarGrupoBtn.onclick = () => salvarEdicao(grupo, nomeOriginal);
}

async function salvarEdicao(grupo, nomeOriginal){
  grupo.nome = document.getElementById('grupoNome').value.trim();
  grupo.link = document.getElementById('grupoLink').value.trim();
  // Se a foto não foi alterada, mantém a original. Se sim, usa a nova prévia.
  grupo.foto = previewFoto.src.trim() || 'https://files.catbox.moe/ls07y5.jpg'; 
  grupo.categoria = document.getElementById('grupoCategoria').value;
  grupo.vip = document.getElementById('grupoVipCodigo').value.trim() === "∜"; 

  // Validação CORRIGIDA usando o novo Regex
  if (!grupo.nome || !WHATSAPP_LINK_REGEX.test(grupo.link) || !grupo.categoria) {
    alert('Preencha corretamente o nome, link válido do WhatsApp e a categoria!');
    return;
  }
  
  // Aviso sobre o upload de foto (mantido)
  if(fotoInput.files.length > 0) {
      alert("ATENÇÃO: A foto foi carregada apenas localmente. Para que ela persista após o carregamento, você precisa implementar o upload para o Firebase Storage ou outro serviço.");
  }
  
  // Verifica se o link já existe em *outro* grupo
  const linkExiste = todosGrupos.some(g => g.link === grupo.link && g.nome !== nomeOriginal);
  if (linkExiste) {
      alert('Já existe outro grupo com esse link. Use um link que ainda não está cadastrado.');
      return;
  }
  
  // Verifica se o nome já existe em *outro* grupo
  const nomeExiste = todosGrupos.some(g => g.nome.toLowerCase() === grupo.nome.toLowerCase() && g.nome !== nomeOriginal);
  if (nomeExiste) {
      alert('Já existe outro grupo com esse nome. Por favor, escolha outro nome.');
      return;
  }

  // Se o nome foi alterado, remove o antigo antes de salvar o novo
  if (nomeOriginal !== grupo.nome) {
    await remove(ref(db, 'grupos/' + nomeOriginal));
  }

  await set(ref(db, 'grupos/' + grupo.nome), grupo);

  // Atualiza no localStorage
  let enviados = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
  enviados = enviados.map(g => g.nome === nomeOriginal ? grupo : g);
  localStorage.setItem('gruposEnviados', JSON.stringify(enviados));

  modal.style.display = 'none';
  // Restaura a função de salvar para o padrão de "novo grupo"
  salvarGrupoBtn.onclick = salvarNovoGrupo; 
  carregarGrupos();
}

function excluirGrupo(grupo){
  if (!confirm('Deseja realmente excluir este grupo?')) return;
  remove(ref(db, 'grupos/' + grupo.nome));
  todosGrupos = todosGrupos.filter(g => g.nome !== grupo.nome);

  let enviados = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
  enviados = enviados.filter(g => g.nome !== grupo.nome);
  localStorage.setItem('gruposEnviados', JSON.stringify(enviados));

  renderizarGrupos(todosGrupos);
}

// Carrega os grupos do arquivo local e do Firebase
async function carregarGrupos() {
  let jsonGrupos = [];
  try {
    // Tenta buscar o arquivo local (se existir)
    const res = await fetch('grupos.json'); 
    const data = await res.json();
    jsonGrupos = Array.isArray(data) ? data : []; 
  } catch (e) {
    console.warn('Nenhum grupos.json encontrado ou erro ao carregar:', e);
    jsonGrupos = [];
  }

  const gruposRef = ref(db, 'grupos');
  // Monitora mudanças no Firebase em tempo real
  onValue(gruposRef, snap => {
    const dadosFirebase = snap.val() ? Object.values(snap.val()) : [];
    const enviadosLocais = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');

    const mapa = new Map();

    // Prioriza dados do Firebase sobre JSON, e remove duplicatas por nome
    [...jsonGrupos, ...dadosFirebase, ...enviadosLocais].forEach(g => {
      if (g?.nome) {
        g.vip = !!g.vip; // Garante que 'vip' é booleano
        mapa.set(g.nome.toLowerCase(), g);
      }
    });

    todosGrupos = Array.from(mapa.values());
    renderizarGrupos(todosGrupos);
  });
}

// ================== RENDERIZAR GRUPOS (ATUALIZADO com novo CSS e botões) ================== //
function renderizarGrupos(lista) {
  const container = document.getElementById('lista-grupos');
  container.innerHTML = '';

  if (lista.length === 0) {
    container.innerHTML = '<p style="color:#ccc;">Nenhum grupo encontrado.</p>';
    return;
  }

  const usuario = localStorage.getItem('usuarioID');

  // Ordena VIPs no topo
  lista.sort((a, b) => {
    if (a.vip && !b.vip) return -1;
    if (!a.vip && b.vip) return 1;
    return 0;
  });

  lista.forEach(g => {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.alignItems = 'center';
    wrapper.style.width = '100%';

    const btn = document.createElement('a');
    btn.className = 'grupo' + (g.vip ? ' vip' : '');
    btn.href = g.link;
    btn.target = '_blank';
    btn.innerHTML = `
      <img class="foto" src="${g.foto}" alt="foto do grupo">
      <div class="info">
        <span class="nome">${g.nome}</span>
        <div class="categoria">${g.categoria || ''}</div>
        <div class="cliques">0</div>
      </div>
    `;

    // Atualiza o contador de cliques em tempo real
    const cliqueRef = ref(db, 'cliques/' + g.nome);
    onValue(cliqueRef, snap => {
      btn.querySelector('.cliques').textContent = `Cliques: ${snap.val() || 0}`;
    });

    // Função para registrar clique e abrir link (CORRIGIDA - usava sintaxe antiga)
    btn.addEventListener('click', e => {
      e.preventDefault();
      // Usa a sintaxe correta do runTransaction modular
      runTransaction(cliqueRef, (currentData) => {
        return (currentData || 0) + 1;
      }).then(() => {
        window.open(g.link, '_blank'); // Abre o link após o clique ser registrado
      });
    });

    wrapper.appendChild(btn);

    // Criação dos botões de ação (Editar/Excluir)
    if (g.dono === usuario) {
      const box = document.createElement('div');
      box.className = 'grupo-acoes-wrapper'; 

      const edit = document.createElement('button');
      edit.textContent = 'Editar';
      edit.className = 'edit-btn'; 
      edit.onclick = () => abrirEdicao(g);

      const del = document.createElement('button');
      del.textContent = 'Excluir';
      del.className = 'delete-btn'; 
      del.onclick = () => excluirGrupo(g);

      box.appendChild(edit);
      box.appendChild(del);
      wrapper.appendChild(box);
    }

    container.appendChild(wrapper);
  });
}


// ================== FUNÇÃO DE COPIAR PIX (MANTIDA) ================== //
copyPixBtn.onclick = async () => {
    try {
        await navigator.clipboard.writeText(pixCodeField.value);
        copyPixBtn.textContent = '✅ Código Copiado!';
    } catch (err) {
        console.error('Falha ao copiar:', err);
        copyPixBtn.textContent = '❌ Erro ao Copiar!';
    }
    setTimeout(() => {
        copyPixBtn.textContent = '📋 Copiar Código Pix';
    }, 3000);
};


// ================== INICIALIZAÇÃO DE EVENTOS ================== //

const comprarVipBtn = document.getElementById('comprarVipBtn');

// O evento agora só abre o modal de Pix
comprarVipBtn.addEventListener("click", (e) => {
  e.preventDefault();
  vipModal.style.display = "flex";
  menu.classList.remove("open");
});

// Outros Eventos (MANTIDOS)
document.getElementById('menuBtn').addEventListener('click',()=>menu.classList.add('open'));
document.getElementById('closeBtn').addEventListener('click',()=>menu.classList.remove('open'));

// Incrementa contador de visitas (CORRIGIDA - usava sintaxe antiga)
const visitasRef = ref(db, 'visitas');
runTransaction(visitasRef, (currentData) => {
  return (currentData || 0) + 1;
});

// Exibe contador de visitas
onValue(visitasRef, snap => {
  contador.textContent = `Visitas: ${snap.val() || 0}`;
});


document.querySelectorAll('.cat-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const cat = btn.dataset.cat.toLowerCase();
    if (cat === 'todos') renderizarGrupos(todosGrupos);
    else renderizarGrupos(todosGrupos.filter(g => g.categoria?.toLowerCase() === cat));
  });
});

fecharVipIcon.onclick = () => { vipModal.style.display = 'none'; };
fecharVipBtn.onclick = () => { vipModal.style.display = 'none'; };


// ABRIR MODAL ENVIAR GRUPO (RESTAURA O O SALVAR POR PADRÃO)
enviarBtn.onclick = (e) => {
  e.preventDefault(); 
  modal.style.display = 'flex';
  menu.classList.remove('open');
  // Limpa os campos para um novo envio
  document.getElementById('grupoNome').value = '';
  document.getElementById('grupoLink').value = '';
  document.getElementById('grupoCategoria').value = '';
  document.getElementById('grupoVipCodigo').value = '';
  previewFoto.src = 'https://files.catbox.moe/ls07y5.jpg';
  // Garante que o botão use a função de "novo grupo"
  salvarGrupoBtn.onclick = salvarNovoGrupo; 
};

// MEUS GRUPOS (MANTIDO)
meusBtn.onclick = (e) => {
  e.preventDefault();
  const usuario = localStorage.getItem('usuarioID');
  if (!usuario) return alert('Você ainda não enviou nenhum grupo.');
  const meus = todosGrupos.filter(g => g.dono === usuario);
  if (meus.length === 0) alert('Você ainda não enviou nenhum grupo.');
  else {
    renderizarGrupos(meus);
    menu.classList.remove('open');
  }
};

// TERMOS E PRIVACIDADE (MANTIDO)
document.getElementById('termosLink').onclick = (e) => {
  e.preventDefault();
  modalTitulo.textContent = "Termos de Uso";
  modalTexto.innerHTML = `
    <p>Bem-vindo ao nosso site de grupos WhatsApp. Ao utilizar este site, você concorda com os seguintes termos:</p>
    <ul>
      <li>Você é responsável por todo o conteúdo que enviar, incluindo links e imagens.</li>
      <li>Não é permitido enviar conteúdo ilegal, ofensivo ou que viole direitos de terceiros.</li>
      <li>O site não se responsabiliza pelo conteúdo dos grupos externos do WhatsApp.</li>
      <li>Os grupos VIPs são destacados apenas para fins de visibilidade dentro do site.</li>
      <li>Podemos alterar os termos de uso a qualquer momento, sendo sua responsabilidade consultar atualizações.</li>
      <li>O uso do site é gratuito, mas o envio de grupos e pagamentos VIP seguem as regras aqui descritas.</li>
      </ul>
    <p>Se você não concorda com estes termos, por favor, não utilize o site.</p>
  `;
  modalTermos.style.display = "flex";
};

document.getElementById('privacidadeLink').onclick = (e) => {
  e.preventDefault();
  modalTitulo.textContent = "Política de Privacidade";
  modalTexto.innerHTML = `
    <p>Esta Política de Privacidade explica como coletamos e usamos os dados dos usuários em nosso site.</p>
    <ul>
      <li>Coletamos apenas informações necessárias para o funcionamento do site, como seu identificador único (usuarioID), cliques nos grupos e visitas ao site.</li>
      <li>O usuarioID é armazenado no seu navegador via localStorage e não contém dados pessoais identificáveis.</li>
      <li>Os dados de cliques e visitas são armazenados no Firebase apenas para exibir estatísticas do site.</li>
      <li>Não compartilhamos seus dados com terceiros.</li>
      <li>Você pode limpar os dados do seu navegador a qualquer momento, removendo seu usuarioID e histórico local.</li>
    </ul>
    <p>Ao continuar usando o site, você concorda com esta política.</p>
  `;
  modalTermos.style.display = "flex";
};

closeModalTermos.onclick = () => modalTermos.style.display = "none";

// ================== INICIAR ================== //
carregarGrupos();
</script>
</body>
</html>
