<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Grupos WhatsApp</title>
<meta property="og:title" content="Grupos whatsapp‚≠ê">
<meta property="og:description" content="Convite para conversar em grupo">
<meta property="og:image" content="https://i.postimg.cc/hvgGzhXs/2bcdefad5d298a05f930aa96e6fbc34a.jpg">
<meta property="og:url" content="https://saniofc.github.io/griffinoria/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">

<script src="https://sdk.mercadopago.com/js/v2"></script>

<style>
/* Reset e Estilos B√°sicos */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,sans-serif;color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding-top:120px;background:#000}
#video-bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1;filter:brightness(0.4)}

/* Header e Categorias */
header{position:fixed;top:0;left:0;width:100%;padding:12px 10px;background:rgba(0,0,0,0.6);text-align:center;z-index:1000}
header h1{font-size:28px;text-shadow:2px 2px 5px #000}
header p{margin-top:4px;text-shadow:1px 1px 3px #000}
#contador{margin-top:4px;color:#ffd700;text-shadow:1px 1px 2px #000;font-size:15px}
#categorias{margin-top:8px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap}
.cat-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:20px;color:#fff;font-size:13px;padding:5px 11px;cursor:pointer;transition:all .2s}
.cat-btn:hover{background:rgba(255,255,255,0.25)}
.cat-btn.active{background:#b78cff;border-color:#b78cff}

/* Menu Lateral */
.menu-icon{position:fixed;top:20px;right:20px;font-size:28px;z-index:1100;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:10px;cursor:pointer}
.menu{position:fixed;top:0;right:-300px;width:250px;height:100%;background:rgba(0,0,0,0.9);padding:30px 20px;transition:right .3s;z-index:1200}
.menu.open{right:0}
.menu .close-btn{position:absolute;top:15px;right:20px;background:none;border:none;color:#fff;font-size:26px;cursor:pointer}
.menu h2{margin-top:50px;color:#b78cff;border-bottom:1px solid #b78cff;padding-bottom:5px;text-align:left}
.menu a{display:block;text-decoration:none;color:#fff;background:rgba(183,140,255,0.12);padding:12px;border-radius:10px;margin-top:15px;text-align:left;font-size:18px}
.menu a:hover{background:rgba(183,140,255,0.25)}

/* Lista de Grupos */
#lista-grupos{width:100%;max-width:420px;padding:30px 20px 60px;display:flex;flex-direction:column;align-items:center;gap:22px}
.grupo{width:100%;max-width:380px;display:flex;align-items:center;gap:14px;background:rgba(0,0,0,0.55);padding:14px 20px;border-radius:40px;text-decoration:none;color:#fff;position:relative;transition:transform .18s,background .18s;border:1px solid rgba(255,255,255,0.1)}
.grupo:hover{transform:scale(1.02);background:rgba(0,0,0,0.65)}
.grupo img.foto{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #fff}
.grupo .info{display:flex;flex-direction:column;align-items:flex-start;justify-content:center;text-align:left}
.grupo span.nome{font-size:19px;font-weight:bold;line-height:1.2}
.grupo .categoria{font-size:14px;color:#ffd700;margin-top:4px}

/* Estilo VIP (Estrela e Fundo Dourado) */
.grupo.vip{box-shadow:0 0 18px 6px rgba(255,215,0,0.12),0 0 28px rgba(255,215,0,0.08) inset;border:1px solid rgba(255,215,0,0.35)}
.grupo.vip::before{content:"‚≠ê";position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:24px;color:#ffd700;text-shadow:0 0 8px #ffda00,0 0 12px #ffb700;animation:shine 1.4s infinite alternate}
@keyframes shine{from{opacity:0.7;transform:translateY(-50%) scale(1);}to{opacity:1;transform:translateY(-50%) scale(1.2)}}

/* Bot√£o de Renda Extra */
.botao{background:rgba(0,0,0,0.7);color:#fff;border:2px solid #fff;border-radius:30px;padding:12px 28px;margin-top:20px;text-decoration:none;font-size:18px;transition:transform .18s,box-shadow .18s;display:inline-block}
.botao:hover{transform:scale(1.04)}

/* Footer */
footer{position:fixed;bottom:0;left:0;width:100%;background:rgba(0,0,0,0.8);color:#ccc;text-align:center;padding:14px 10px;font-size:14px;line-height:1.6;z-index:2000}
footer a{color:#b78cff;text-decoration:none}

/* Modal Geral e Termos */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:5000}
.modal-content{background:#111;padding:20px;border-radius:20px;max-width:400px;width:90%;text-align:center;color:#fff;position:relative}
.modal-content h3{margin-bottom:15px}
.modal-content input, .modal-content select{width:90%;margin:5px 0;padding:8px;border-radius:10px;border:none}
.modal-content button{padding:10px 20px;margin-top:10px;border:none;border-radius:15px;background:#b78cff;color:#fff;cursor:pointer;transition:0.2s}
.modal-content button:hover{background:#a56be0}
.modal .close-modal{position:absolute;top:10px;right:15px;font-size:22px;cursor:pointer}

/* Anima√ß√£o Modal VIP */
@keyframes fadeZoom {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
/* Estilo para o conte√∫do do Modal VIP */
#vipModal > .modal-content {
    animation: fadeZoom 0.25s ease;
    border: 1px solid gold;
    padding: 25px;
    max-width: 350px;
}
/* Novo Estilo para o Modal de Aviso VIP/Geral */
#modalAvisoVip > .modal-content {
    border: 3px solid gold;
    background: #0d0d0d;
}
</style>
</head>
<body>
<video id="video-bg" autoplay muted loop playsinline>
  <source src="https://files.catbox.moe/dymzif.mp4" type="video/mp4">
</video>

<header>
  <h1>Grupos WhatsApp</h1>
  <p></p>
  <p id="contador">Visitas: 0</p>
  <div id="categorias">
    <button class="cat-btn active" data-cat="Todos">Todos</button>
    <button class="cat-btn" data-cat="amizade">Amizade</button>
    <button class="cat-btn" data-cat="zoeira">Zoeira</button>
    <button class="cat-btn" data-cat="namoro">Namoro</button>
  </div>
</header>

<div class="menu-icon" id="menuBtn">üìù</div>
<div class="menu" id="sideMenu">
  <button class="close-btn" id="closeBtn">‚ùå</button>
  <h2>informa√ß√µes</h2>
  <a href="https://br.shp.ee/1r878lx?smtt=0.0.9" target="_blank">üõçÔ∏è Loja da Miih</a>
  <a href="https://wa.me/5521977231625?text=Quero%20alugar%20bot" target="_blank">ü§ñ Alugar bot</a>
  <a href="#" id="meusGrupos">üìù Meus Grupos</a>
  <a href="#" id="enviarGrupo">üöÄ Enviar Meu Grupo</a>
  <a href="https://wa.me/5521977231625?text=Quero%20comprar%20bot" target="_blank">ü§ñ Comprar bot</a>
  <a href="#" id="comprarVipBtn">‚≠ê Comprar VIP</a>
</div>

<div id="lista-grupos"></div>
<a class="botao" href="https://linkfly.to/grifinoria" target="_blank">Renda extra em casaüßëüèª‚Äçüíªüí∞</a>

<div id="modalTermos" class="modal">
  <div class="modal-content">
    <span class="close-modal">‚ùå</span>
    <h3 id="modalTitulo"></h3>
    <div id="modalTexto" style="text-align:left; max-height:300px; overflow-y:auto;"></div>
  </div>
</div>

<div id="vipModal" class="modal">
  <div class="modal-content" id="vip-content-container">
    <span class="close-modal" id="fecharVipIcon">‚ùå</span>
    <h3>‚≠ê Beneficios do VIP ‚≠ê</h3>
    <p>Grupos VIPs ser√£o mais vis√≠veis e ter√£o mais visitas!</p>
    <p><strong>Valores:</strong><br>üöÄ R$5,00 = 24 horas<br>üöÄ R$10,00 = 48 horas</p>
    
    <div id="mercadopago-button-container" style="margin-top:15px;"></div>

    <br>
    <button id="fecharVipBtn"
            style="background:#e74c3c; color:#fff; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">
      Fechar
    </button>
  </div>
</div>

<div id="modalAvisoVip" class="modal">
  <div class="modal-content">
    <span class="close-modal" id="fecharAvisoVip">‚ùå</span>
    <h3 id="avisoVipTitulo"></h3>
    <p id="avisoVipMensagem"></p>
    <p id="avisoVipCodigo" style="font-size:24px; font-weight:bold; color:#ffd700; margin-top:15px;"></p>
  </div>
</div>

<div id="modalEnvioGrupo" class="modal">
  <div class="modal-content" style="background:#111; padding:20px; border-radius:20px; text-align:center; max-width:400px; width:90%; position:relative; color:#fff;">
    <span class="close-modal" onclick="document.getElementById('modalEnvioGrupo').style.display = 'none';" style="position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer;">‚ùå</span>
    <h3>Enviar Meu Grupo</h3>
    <input type="text" id="grupoNome" placeholder="Nome do grupo" style="width:90%; margin:5px 0; padding:8px; border-radius:10px; border:none;">
    <input type="text" id="grupoLink" placeholder="Link do grupo (https://chat.whatsapp.com/...)" style="width:90%; margin:5px 0; padding:8px; border-radius:10px; border:none;">
    <input type="file" id="grupoFotoUpload" accept="image/*" style="width:90%; margin:8px 0; color:#ccc;">
    <img id="previewFoto" src="https://files.catbox.moe/ls07y5.jpg" style="width:90px; height:90px; border-radius:50%; object-fit:cover; margin-top:5px; border:2px solid #fff;" alt="Pr√©via da foto">
    <select id="grupoCategoria" style="width:90%; margin:5px 0; padding:8px; border-radius:10px; border:none;">
      <option value="">Selecione a categoria</option>
      <option value="Amizade">Amizade</option>
      <option value="Zoeira">Zoeira</option>
      <option value="Namoro">Namoro</option>
    </select>
    <input type="text" id="grupoVipCodigo" placeholder="C√≥digo VIP (opcional)" style="width:90%; margin:5px 0; padding:8px; border-radius:10px; border:none;">
    <button id="salvarGrupo"
      style="padding:10px 20px; margin-top:10px; border:none; border-radius:15px; background:#2ecc71; color:#fff; cursor:pointer; font-weight:bold; transition: background 0.2s;">
      Enviar grupo
    </button>
    <p id="mensagemEnvio" style="margin-top:10px; color:#0f0; font-weight:bold; display:none;">Grupo enviado com sucesso!</p>
  </div>
</div>

<footer>
  <a href="#" id="termosLink">Termos de Uso</a>
  <a href="#" id="privacidadeLink">Politica de Privacidade</a><br>
  ¬© COPYRIGHT 2025 - <a href="https://saniofc.github.io/griffinoria/" target="_blank">saniofc.github.io/griffinoria/</a>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, set, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// URL base do seu site para retorno do Mercado Pago
const SITE_URL = "https://saniofc.github.io/griffinoria/";

// *** Seu link real do Render ***
const RENDER_API_URL = "https://gri-t9jx.onrender.com/gerar-preferencia"; 

// Credenciais do Firebase (MANTIDAS)
const firebaseConfig = {
  apiKey: "AIzaSyDsrYjO2yVTemKqwmJRzNjh5sfaMalPqhE",
  authDomain: "cliques-4a2c1.firebaseapp.com",
  databaseURL: "https://cliques-4a2c1-default-rtdb.firebaseio.com",
  projectId: "cliques-4a2c1",
  storageBucket: "cliques-4a2c1.firebasestorage.app",
  messagingSenderId: "903875153255",
  appId: "1:903875153255:web:ff3cf25e059b10d665b3c2",
  measurementId: "G-BQHZ7FWRJD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// CHAVE P√öBLICA DO MERCADO PAGO (MANTIDA)
const MERCADOPAGO_PUBLIC_KEY = "APP_USR-747669d7-f43b-40c3-8b5f-3a496e478245";

// Inicializa Mercado Pago
const mp = new MercadoPago(MERCADOPAGO_PUBLIC_KEY, {
    locale: 'pt-BR'
});

// Vari√°veis de Elementos (MANTIDAS)
const menu = document.getElementById('sideMenu');
const enviarBtn = document.getElementById('enviarGrupo');
const meusBtn = document.getElementById('meusGrupos');
const contador = document.getElementById('contador');
const modalTermos = document.getElementById('modalTermos');
const closeModalTermos = modalTermos.querySelector('.close-modal');
const modalTitulo = document.getElementById('modalTitulo');
const modalTexto = document.getElementById('modalTexto');

const vipModal = document.getElementById('vipModal');
const fecharVipIcon = document.getElementById('fecharVipIcon');
const fecharVipBtn = document.getElementById('fecharVipBtn');

const modalAvisoVip = document.getElementById('modalAvisoVip');
const avisoVipTitulo = document.getElementById('avisoVipTitulo');
const avisoVipMensagem = document.getElementById('avisoVipMensagem');
const avisoVipCodigo = document.getElementById('avisoVipCodigo');
document.getElementById('fecharAvisoVip').onclick = () => modalAvisoVip.style.display = 'none';


let todosGrupos = [];

// Regex para validar link de convite do WhatsApp (MANTIDO)
const WHATSAPP_LINK_REGEX = /^https?:\/\/(chat\.)?whatsapp\.com\/(invite\/)?[A-Za-z0-9]{22}$/;

// ================== CRIA√á√ÉO E MANIPULA√á√ÉO DO MODAL DE GRUPO (CORRIGIDO) ================== //

// Sele√ß√£o corrigida! Pega o modal pelo ID √∫nico.
const modal = document.getElementById('modalEnvioGrupo'); 
const previewFoto = document.getElementById("previewFoto");
const fotoInput = document.getElementById("grupoFotoUpload");
const salvarGrupoBtn = document.getElementById('salvarGrupo');

// Eventos de hover (MANTIDOS)
salvarGrupoBtn.addEventListener('mouseover', () => salvarGrupoBtn.style.background = '#27ae60');
salvarGrupoBtn.addEventListener('mouseout', () => salvarGrupoBtn.style.background = '#2ecc71');

// Evento de preview da foto (MANTIDO)
fotoInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (ev) => (previewFoto.src = ev.target.result);
    reader.readAsDataURL(file);
  }
});

// O evento de fechar foi movido para o onclick do HTML no span do modal!

// ================== SALVAR NOVO GRUPO (MANTIDO) ================== //
async function salvarNovoGrupo() {
  const nome = document.getElementById('grupoNome').value.trim();
  const link = document.getElementById('grupoLink').value.trim();
  const foto = previewFoto.src.trim() || 'https://files.catbox.moe/ls07y5.jpg';
  const categoria = document.getElementById('grupoCategoria').value;
  const vipCodigo = document.getElementById('grupoVipCodigo').value.trim();

  // Valida√ß√£o conforme solicitado: Nome, Link do WhatsApp e Categoria OBRIGAT√ìRIOS
  if (!nome) {
    alert('O nome do grupo √© obrigat√≥rio.');
    return;
  }
  if (!WHATSAPP_LINK_REGEX.test(link)) {
    alert('Por favor, use um link de convite do WhatsApp v√°lido (ex: https://chat.whatsapp.com/...).');
    return;
  }
  if (!categoria) {
    alert('A categoria do grupo √© obrigat√≥ria. Por favor, escolha uma.');
    return;
  }

  // Aviso sobre foto tempor√°ria (MANTIDO)
  if(fotoInput.files.length > 0) {
      alert("ATEN√á√ÉO: A foto foi carregada apenas localmente. Para que ela persista ap√≥s o carregamento, voc√™ precisa implementar o upload para o Firebase Storage ou outro servi√ßo.");
  }
  
  // Valida√ß√£o: Link repetido (CONFORME SOLICITADO)
  const linkExiste = todosGrupos.some(g => g.link === link);
  if (linkExiste) {
      alert('J√° existe um grupo com esse link. Use um link que ainda n√£o est√° cadastrado.');
      return;
  }
  
  // O nome √© usado como chave no Firebase, ent√£o tem que ser √∫nico
  const nomeExiste = todosGrupos.some(g => g.nome.toLowerCase() === nome.toLowerCase());
  if (nomeExiste) {
      alert('J√° existe um grupo com esse nome. Por favor, escolha outro nome.');
      return;
  }
  
  // Gera ID de usu√°rio se n√£o existir (MANTIDO)
  const isVip = vipCodigo === "‚àú"; 
  const usuario = localStorage.getItem('usuarioID') || crypto.randomUUID();
  localStorage.setItem('usuarioID', usuario);

  const novoGrupo = { nome, link, foto, categoria, dono: usuario, vip: isVip };

  // Salva no Firebase
  await set(ref(db, 'grupos/' + nome), novoGrupo);

  const msg = document.getElementById('mensagemEnvio');
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 3000);

  // Salva localmente para rastreio
  let enviados = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
  enviados.push(novoGrupo);
  localStorage.setItem('gruposEnviados', JSON.stringify(enviados));
  
  carregarGrupos(); 
  modal.style.display = 'none';
};

salvarGrupoBtn.onclick = salvarNovoGrupo;

// ================== FUN√á√ïES DE EDI√á√ÉO/EXCLUS√ÉO, CARREGAR E RENDERIZAR GRUPOS (MANTIDAS) ================== //
// Manuten√ß√£o das fun√ß√µes CRUD para garantir o carregamento da lista
function abrirEdicao(grupo){
  modal.style.display = 'flex';
  document.getElementById('grupoNome').value = grupo.nome;
  document.getElementById('grupoLink').value = grupo.link;
  previewFoto.src = grupo.foto;
  document.getElementById('grupoCategoria').value = grupo.categoria;
  document.getElementById('grupoVipCodigo').value = grupo.vip ? "‚àú" : "";
  
  const nomeOriginal = grupo.nome; 
  
  salvarGrupoBtn.onclick = null;
  salvarGrupoBtn.onclick = () => salvarEdicao(grupo, nomeOriginal);
}

async function salvarEdicao(grupo, nomeOriginal){
  grupo.nome = document.getElementById('grupoNome').value.trim();
  grupo.link = document.getElementById('grupoLink').value.trim();
  grupo.foto = previewFoto.src.trim() || 'https://files.catbox.moe/ls07y5.jpg';
  grupo.categoria = document.getElementById('grupoCategoria').value;
  grupo.vip = document.getElementById('grupoVipCodigo').value.trim() === "‚àú"; 

  if (!grupo.nome || !WHATSAPP_LINK_REGEX.test(grupo.link) || !grupo.categoria) {
    alert('Preencha corretamente o nome, link v√°lido do WhatsApp e a categoria!');
    return;
  }
  
  if(fotoInput.files.length > 0) {
      alert("ATEN√á√ÉO: A foto foi carregada apenas localmente. Para que ela persista ap√≥s o carregamento, voc√™ precisa implementar o upload para o Firebase Storage ou outro servi√ßo.");
  }
  
  const linkExiste = todosGrupos.some(g => g.link === grupo.link && g.nome !== nomeOriginal);
  if (linkExiste) {
      alert('J√° existe outro grupo com esse link. Use um link que ainda n√£o est√° cadastrado.');
      return;
  }
  
  const nomeExiste = todosGrupos.some(g => g.nome.toLowerCase() === grupo.nome.toLowerCase() && g.nome !== nomeOriginal);
  if (nomeExiste) {
      alert('J√° existe outro grupo com esse nome. Por favor, escolha outro nome.');
      return;
  }

  if (nomeOriginal !== grupo.nome) {
    await remove(ref(db, 'grupos/' + nomeOriginal));
  }

  await set(ref(db, 'grupos/' + grupo.nome), grupo);

  let enviados = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
  enviados = enviados.map(g => g.nome === nomeOriginal ? grupo : g);
  localStorage.setItem('gruposEnviados', JSON.stringify(enviados));

  modal.style.display = 'none';
  carregarGrupos();
}

function excluirGrupo(grupo){
  if (!confirm('Deseja realmente excluir este grupo?')) return;
  remove(ref(db, 'grupos/' + grupo.nome));
  todosGrupos = todosGrupos.filter(g => g.nome !== grupo.nome);

  let enviados = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');
  enviados = enviados.filter(g => g.nome !== grupo.nome);
  localStorage.setItem('gruposEnviados', JSON.stringify(enviados));

  renderizarGrupos(todosGrupos);
}
async function carregarGrupos() {
  let jsonGrupos = [];
  try {
    const res = await fetch('grupos.json');
    const data = await res.json();
    jsonGrupos = Array.isArray(data) ? data : []; 
  } catch (e) {
    console.warn('Nenhum grupos.json encontrado ou erro ao carregar:', e);
    jsonGrupos = [];
  }

  const gruposRef = ref(db, 'grupos');
  onValue(gruposRef, snap => {
    const dadosFirebase = snap.val() ? Object.values(snap.val()) : [];
    const enviadosLocais = JSON.parse(localStorage.getItem('gruposEnviados') || '[]');

    const mapa = new Map();

    [...jsonGrupos, ...dadosFirebase, ...enviadosLocais].forEach(g => {
      if (g?.nome) {
        g.vip = !!g.vip;
        mapa.set(g.nome.toLowerCase(), g);
      }
    });

    todosGrupos = Array.from(mapa.values());
    renderizarGrupos(todosGrupos);
  });
}
function renderizarGrupos(lista) {
  const container = document.getElementById('lista-grupos');
  container.innerHTML = '';

  if (lista.length === 0) {
    container.innerHTML = '<p style="color:#ccc;">Nenhum grupo encontrado.</p>';
    return;
  }

  const usuario = localStorage.getItem('usuarioID');

  lista.sort((a, b) => {
    if (a.vip && !b.vip) return -1;
    if (!a.vip && b.vip) return 1;
    return 0;
  });

  lista.forEach(g => {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.alignItems = 'center';
    wrapper.style.width = '100%';

    const btn = document.createElement('a');
    btn.className = 'grupo' + (g.vip ? ' vip' : '');
    btn.href = g.link;
    btn.target = '_blank';
    btn.innerHTML = `
      <img class="foto" src="${g.foto}" alt="foto do grupo">
      <div class="info">
        <span class="nome">${g.nome}</span>
        <div class="categoria">${g.categoria || ''}</div>
        <div class="cliques" style="position:absolute;top:6px;right:14px;font-size:12px;color:#ffd700;">0</div>
      </div>
    `;

    const cliqueRef = ref(db, 'cliques/' + g.nome);
    onValue(cliqueRef, snap => {
      btn.querySelector('.cliques').textContent = `Cliques: ${snap.val() || 0}`;
    });

    btn.addEventListener('click', e => {
      e.preventDefault();
      runTransaction(cliqueRef, c => (c || 0) + 1).then(() => window.open(g.link, '_blank'));
    });

    wrapper.appendChild(btn);

    if (g.dono === usuario) {
      const box = document.createElement('div');
      box.style.display = 'flex';
      box.style.gap = '6px';
      box.style.marginTop = '8px';

      const edit = document.createElement('button');
      edit.textContent = 'Editar';
      edit.style.cssText = 'background:#2ecc71;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:13px;transition:0.2s;';
      edit.addEventListener('mouseover', () => edit.style.background = '#27ae60');
      edit.addEventListener('mouseout', () => edit.style.background = '#2ecc71');
      edit.onclick = () => abrirEdicao(g);

      const del = document.createElement('button');
      del.textContent = 'Excluir';
      del.style.cssText = 'background:#e74c3c;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:13px;transition:0.2s;';
      del.addEventListener('mouseover', () => del.style.background = '#c0392b');
      del.addEventListener('mouseout', () => del.style.background = '#e74c3c');
      del.onclick = () => excluirGrupo(g);

      box.appendChild(edit);
      box.appendChild(del);
      wrapper.appendChild(box);
    }

    container.appendChild(wrapper);
  });
}
function renderizarMercadoPago(preferenceId) {
    const container = document.getElementById('mercadopago-button-container');
    container.innerHTML = '';
    
    if (preferenceId === "TEST-f463372c-f3e0-40e1-a083-d95b5420377e") {
        container.innerHTML = `<p style="color:yellow; font-weight:bold;">‚ö†Ô∏è Substitua este ID de teste por um ID de Prefer√™ncia real gerado no seu servidor Render para o pagamento funcionar!</p>`;
    }

    mp.checkout({
        preference: {
            id: preferenceId 
        },
        render: {
            container: '#mercadopago-button-container',
            label: '‚≠ê Pagar R$5,00 (24h VIP)',
        }
    });
}


// ================== INICIALIZA√á√ÉO DE EVENTOS (MANTIDA) ================== //

const comprarVipBtn = document.getElementById('comprarVipBtn');

comprarVipBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  vipModal.style.display = "flex";
  menu.classList.remove("open");
  
  // 1. Obt√©m ou gera o ID do usu√°rio (external_reference)
  let usuario = localStorage.getItem('usuarioID');
  if (!usuario) {
      usuario = window.crypto.randomUUID(); 
      localStorage.setItem('usuarioID', usuario); 
  }

  let preferenceIdReal = "TEST-f463372c-f3e0-40e1-a083-d95b5420377e"; 
  
  // URLs de retorno para o MP - Passamos o ID do usu√°rio
  const SUCCESS_URL = SITE_URL + "?status=approved&external_reference=" + usuario;
  const FAILURE_URL = SITE_URL + "?status=failure&external_reference=" + usuario;
  const PENDING_URL = SITE_URL + "?status=pending&external_reference=" + usuario;

  try {
    // 2. Chama seu backend no Render
    const response = await fetch(RENDER_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
          valor: 5,
          external_reference: usuario, // Envia o ID do usu√°rio para o backend
          back_urls: { 
              success: SUCCESS_URL,
              failure: FAILURE_URL,
              pending: PENDING_URL 
          }
      }) 
    });
    
    if (!response.ok) {
        throw new Error(`Servidor Render respondeu com erro: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.preferenceId) {
      preferenceIdReal = data.preferenceId; 
    } else {
      console.warn('Backend retornou sucesso, mas sem preferenceId. Usando ID de teste.');
    }
    
  } catch (err) {
    console.error('Falha na comunica√ß√£o com o backend:', err.message);
    alert('Erro ao se conectar com o servidor. O bot√£o de pagamento ser√° exibido usando um ID de TESTE.');
  } finally {
    renderizarMercadoPago(preferenceIdReal); 
  }
});

// Outros Eventos (MANTIDOS)
document.getElementById('menuBtn').addEventListener('click',()=>menu.classList.add('open'));
document.getElementById('closeBtn').addEventListener('click',()=>menu.classList.remove('open'));

const visitasRef = ref(db, 'visitas');
runTransaction(visitasRef, v => (v || 0) + 1);
onValue(visitasRef, snap => {
  contador.textContent = `Visitas: ${snap.val() || 0}`;
});

document.querySelectorAll('.cat-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const cat = btn.dataset.cat.toLowerCase();
    if (cat === 'todos') renderizarGrupos(todosGrupos);
    else renderizarGrupos(todosGrupos.filter(g => g.categoria?.toLowerCase() === cat));
  });
});

fecharVipIcon.onclick = () => { vipModal.style.display = 'none'; };
fecharVipBtn.onclick = () => { vipModal.style.display = 'none'; };


// ABRIR MODAL ENVIAR GRUPO (MANTIDO)
enviarBtn.onclick = (e) => {
  e.preventDefault(); 
  modal.style.display = 'flex';
  menu.classList.remove('open');
  document.getElementById('grupoNome').value = '';
  document.getElementById('grupoLink').value = '';
  document.getElementById('grupoCategoria').value = '';
  document.getElementById('grupoVipCodigo').value = '';
  previewFoto.src = 'https://files.catbox.moe/ls07y5.jpg';
  salvarGrupoBtn.onclick = salvarNovoGrupo;
};

// MEUS GRUPOS (MANTIDO)
meusBtn.onclick = (e) => {
  e.preventDefault();
  const usuario = localStorage.getItem('usuarioID');
  if (!usuario) return alert('Voc√™ ainda n√£o enviou nenhum grupo.');
  const meus = todosGrupos.filter(g => g.dono === usuario);
  if (meus.length === 0) alert('Voc√™ ainda n√£o enviou nenhum grupo.');
  else {
    renderizarGrupos(meus);
    menu.classList.remove('open');
  }
};

// TERMOS E PRIVACIDADE (MANTIDO)
document.getElementById('termosLink').onclick = (e) => {
  e.preventDefault();
  modalTitulo.textContent = "Termos de Uso";
  modalTexto.innerHTML = `
    <p>Bem-vindo ao nosso site de grupos WhatsApp. Ao utilizar este site, voc√™ concorda com os seguintes termos:</p>
    <ul>
      <li>Voc√™ √© respons√°vel por todo o conte√∫do que enviar, incluindo links e imagens.</li>
      <li>N√£o √© permitido enviar conte√∫do ilegal, ofensivo ou que viole direitos de terceiros.</li>
      <li>O site n√£o se responsabiliza pelo conte√∫do dos grupos externos do WhatsApp.</li>
      <li>Os grupos VIPs s√£o destacados apenas para fins de visibilidade dentro do site.</li>
      <li>Podemos alterar os termos de uso a qualquer momento, sendo sua responsabilidade consultar atualiza√ß√µes.</li>
      <li>O uso do site √© gratuito, mas o envio de grupos e pagamentos VIP seguem as regras aqui descritas.</li>
    </ul>
    <p>Se voc√™ n√£o concorda com estes termos, por favor, n√£o utilize o site.</p>
  `;
  modalTermos.style.display = "flex";
};

document.getElementById('privacidadeLink').onclick = (e) => {
  e.preventDefault();
  modalTitulo.textContent = "Pol√≠tica de Privacidade";
  modalTexto.innerHTML = `
    <p>Esta Pol√≠tica de Privacidade explica como coletamos e usamos os dados dos usu√°rios em nosso site.</p>
    <ul>
      <li>Coletamos apenas informa√ß√µes necess√°rias para o funcionamento do site, como seu identificador √∫nico (usuarioID), cliques nos grupos e visitas ao site.</li>
      <li>O usuarioID √© armazenado no seu navegador via localStorage e n√£o cont√©m dados pessoais identific√°veis.</li>
      <li>Os dados de cliques e visitas s√£o armazenados no Firebase apenas para exibir estat√≠sticas do site.</li>
      <li>N√£o compartilhamos seus dados com terceiros.</li>
      <li>Voc√™ pode limpar os dados do seu navegador a qualquer momento, removendo seu usuarioID e hist√≥rico local.</li>
    </ul>
    <p>Ao continuar usando o site, voc√™ concorda com esta pol√≠tica.</p>
  `;
  modalTermos.style.display = "flex";
};

closeModalTermos.onclick = () => modalTermos.style.display = "none";

// ================== NOVO: CHECAR RETORNO DO MERCADO PAGO (MANTIDO) ================== //

function checkVipReturn() {
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    const externalReference = urlParams.get('external_reference');

    if (status === 'approved' && externalReference) {
        // Gera um c√≥digo VIP TEMPOR√ÅRIO para o usu√°rio inserir
        const temporaryVipCode = '‚àú'; // Usando o mesmo s√≠mbolo
        
        avisoVipTitulo.textContent = "‚úÖ Pagamento Aprovado!";
        avisoVipMensagem.innerHTML = `
            Seu pagamento foi aprovado com sucesso!
            <br>Use o c√≥digo abaixo para ativar o VIP ao enviar um grupo.
            <br>
            <strong style="color:red;">AVISO:</strong> Este c√≥digo √© tempor√°rio e apenas para o frontend. A ativa√ß√£o definitiva do VIP depende do seu servidor **Render** (via webhook).
        `;
        avisoVipCodigo.textContent = temporaryVipCode;
        modalAvisoVip.style.display = 'flex';
        
        // Remove os par√¢metros da URL para evitar que o aviso apare√ßa novamente no refresh
        history.replaceState(null, '', location.pathname);

    } else if (status && externalReference) {
        avisoVipTitulo.textContent = "‚ùå Status do Pagamento";
        avisoVipMensagem.innerHTML = `
            Seu pagamento retornou com o status: **${status.toUpperCase()}**. 
            <br>
            Se houver d√∫vidas, entre em contato com o suporte do Mercado Pago.
        `;
        avisoVipCodigo.textContent = "";
        modalAvisoVip.style.display = 'flex';
        
        // Remove os par√¢metros da URL
        history.replaceState(null, '', location.pathname);
    }
}

// ================== INICIAR ================== //
carregarGrupos();
checkVipReturn(); // Executa a checagem ao carregar a p√°gina
</script>
</body>
</html>
