<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Grupos WhatsApp</title>
<meta property="og:title" content="Grupos whatsapp⭐">
<meta property="og:description" content="Convite para conversar em grupo">
<meta property="og:image" content="https://i.postimg.cc/hvgGzhXs/2bcdefad5d298a05f930aa96e6fbc34a.jpg">
<meta property="og:url" content="https://saniofc.github.io/griffinoria/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">

<script src="https://sdk.mercadopago.com/js/v2"></script>

<style>
/* ... SEU CSS PERMANECE INALTERADO, SEM CORREÇÕES NECESSÁRIAS ... */
/* Reset e Estilos Básicos */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,sans-serif;color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding-top:120px;background:#000}
#video-bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1;filter:brightness(0.4)}

/* Header e Categorias */
header{position:fixed;top:0;left:0;width:100%;padding:12px 10px;background:rgba(0,0,0,0.6);text-align:center;z-index:1000}
header h1{font-size:28px;text-shadow:2px 2px 5px #000}
header p{margin-top:4px;text-shadow:1px 1px 3px #000}
#contador{margin-top:4px;color:#ffd700;text-shadow:1px 1px 2px #000;font-size:15px}
#categorias{margin-top:8px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap}
.cat-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:20px;color:#fff;font-size:13px;padding:5px 11px;cursor:pointer;transition:all .2s}
.cat-btn:hover{background:rgba(255,255,255,0.25)}
.cat-btn.active{background:#b78cff;border-color:#b78cff}

/* Menu Lateral */
.menu-icon{position:fixed;top:20px;right:20px;font-size:28px;z-index:1100;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:10px;cursor:pointer}
.menu{position:fixed;top:0;right:-300px;width:250px;height:100%;background:rgba(0,0,0,0.9);padding:30px 20px;transition:right .3s;z-index:1200}
.menu.open{right:0}
.menu .close-btn{position:absolute;top:15px;right:20px;background:none;border:none;color:#fff;font-size:26px;cursor:pointer}
.menu h2{margin-top:50px;color:#b78cff;border-bottom:1px solid #b78cff;padding-bottom:5px;text-align:left}
.menu a{display:block;text-decoration:none;color:#fff;background:rgba(183,140,255,0.12);padding:12px;border-radius:10px;margin-top:15px;text-align:left;font-size:18px}
.menu a:hover{background:rgba(183,140,255,0.25)}

/* Lista de Grupos */
#lista-grupos{width:100%;max-width:420px;padding:30px 20px 60px;display:flex;flex-direction:column;align-items:center;gap:22px}
.grupo{width:100%;max-width:380px;display:flex;align-items:center;gap:14px;background:rgba(0,0,0,0.55);padding:14px 20px;border-radius:40px;text-decoration:none;color:#fff;position:relative;transition:transform .18s,background .18s;border:1px solid rgba(255,255,255,0.1)}
.grupo:hover{transform:scale(1.02);background:rgba(0,0,0,0.65)}
.grupo img.foto{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #fff}
.grupo .info{display:flex;flex-direction:column;align-items:flex-start;justify-content:center;text-align:left}
.grupo span.nome{font-size:19px;font-weight:bold;line-height:1.2}
.grupo .categoria{font-size:14px;color:#ffd700;margin-top:4px}

/* Estilo VIP (Estrela e Fundo Dourado) */
.grupo.vip{box-shadow:0 0 18px 6px rgba(255,215,0,0.12),0 0 28px rgba(255,215,0,0.08) inset;border:1px solid rgba(255,215,0,0.35)}
.grupo.vip::before{content:"⭐";position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:24px;color:#ffd700;text-shadow:0 0 8px #ffda00,0 0 12px #ffb700;animation:shine 1.4s infinite alternate}
@keyframes shine{from{opacity:0.7;transform:translateY(-50%) scale(1);}to{opacity:1;transform:translateY(-50%) scale(1.2)}}

/* Botão de Renda Extra */
.botao{background:rgba(0,0,0,0.7);color:#fff;border:2px solid #fff;border-radius:30px;padding:12px 28px;margin-top:20px;text-decoration:none;font-size:18px;transition:transform .18s,box-shadow .18s;display:inline-block}
.botao:hover{transform:scale(1.04)}

/* Footer */
footer{position:fixed;bottom:0;left:0;width:100%;background:rgba(0,0,0,0.8);color:#ccc;text-align:center;padding:14px 10px;font-size:14px;line-height:1.6;z-index:2000}
footer a{color:#b78cff;text-decoration:none}

/* Modal Geral e Termos */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:5000}
.modal-content{background:#111;padding:20px;border-radius:20px;max-width:400px;width:90%;text-align:center;color:#fff;position:relative}
.modal-content h3{margin-bottom:15px}
.modal-content input, .modal-content select{width:90%;margin:5px 0;padding:8px;border-radius:10px;border:none}
.modal-content button{padding:10px 20px;margin-top:10px;border:none;border-radius:15px;background:#b78cff;color:#fff;cursor:pointer;transition:0.2s}
.modal-content button:hover{background:#a56be0}
.modal .close-modal{position:absolute;top:10px;right:15px;font-size:22px;cursor:pointer}

/* Animação Modal VIP */
@keyframes fadeZoom {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
/* Estilo para o conteúdo do Modal VIP */
#vipModal > .modal-content { 
    animation: fadeZoom 0.25s ease;
    border: 1px solid gold; 
    padding: 25px;
    max-width: 350px;
}

/* NOVO: Modal de Código VIP */
#vipCodeModal .modal-content {
    background: linear-gradient(145deg, #2c3e50, #1c2833);
    border: 3px solid gold;
}
#vipCodeDisplay {
    background: #1e2a36;
    color: #ffd700;
    padding: 15px;
    border-radius: 8px;
    font-size: 20px;
    font-weight: bold;
    margin: 15px 0;
    border: 1px dashed #ffd700;
}
</style>
</head>
<body>

<video id="video-bg" autoplay muted loop playsinline>
  <source src="https://files.catbox.moe/dymzif.mp4" type="video/mp4">
</video>

<header>
  <h1>Grupos WhatsApp</h1>
  <p></p>
  <p id="contador">Visitas: 0</p>
  <div id="categorias">
    <button class="cat-btn active" data-cat="Todos">Todos</button>
    <button class="cat-btn" data-cat="amizade">Amizade</button>
    <button class="cat-btn" data-cat="zoeira">Zoeira</button>
    <button class="cat-btn" data-cat="namoro">Namoro</button>
  </div>
</header>

<div class="menu-icon" id="menuBtn">📝</div>
<div class="menu" id="sideMenu">
  <button class="close-btn" id="closeBtn">❌</button>
  <h2>informações</h2>
  <a href="https://br.shp.ee/1r878lx?smtt=0.0.9" target="_blank">🛍️ Loja da Miih</a>
  <a href="https://wa.me/5521977231625?text=Quero%20alugar%20bot" target="_blank">🤖 Alugar bot</a>
  <a href="#" id="meusGrupos">📝 Meus Grupos</a>
  <a href="#" id="enviarGrupo">🚀 Enviar Meu Grupo</a>
  <a href="https://wa.me/5521977231625?text=Quero%20comprar%20bot" target="_blank">🤖 Comprar bot</a>
  <a href="#" id="comprarVipBtn">⭐ Comprar VIP</a>
</div>

<div id="lista-grupos"></div>
<a class="botao" href="https://linkfly.to/grifinoria" target="_blank">Renda extra em casa🧑🏻‍💻💰</a>

<div id="modalTermos" class="modal">
  <div class="modal-content">
    <span class="close-modal">❌</span>
    <h3 id="modalTitulo"></h3>
    <div id="modalTexto" style="text-align:left; max-height:300px; overflow-y:auto;"></div>
  </div>
</div>

<div id="vipModal" class="modal">
  <div class="modal-content" id="vip-content-container">
    <span class="close-modal" id="fecharVipIcon">❌</span>
    <h3>⭐ Beneficios do VIP ⭐</h3>
    <p>Grupos VIPs serão mais visíveis e terão mais visitas!</p>
    <p><strong>Valores:</strong><br>🚀 R$5,00 = 24 horas<br>🚀 R$10,00 = 48 horas</p>
    
    <div id="mercadopago-button-container" style="margin-top:15px;"></div>
    
    <button id="fecharVipBtn"
            style="background:#e74c3c; color:#fff; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; margin-top:20px;">
      Fechar
    </button>
  </div>
</div>

<div id="vipCodeModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="closeVipCodeModal">❌</span>
        <h3>🎉 Seu Código VIP!</h3>
        <p>Use este código no seu grupo para ativar o destaque por 24h:</p>
        <div id="vipCodeDisplay">...</div>
        <button id="copyVipCodeBtn" style="background:#b78cff;">
            Copiar Código
        </button>
    </div>
</div>

<footer>
  <a href="#" id="termosLink">Termos de Uso</a>
  <a href="#" id="privacidadeLink">Politica de Privacidade</a><br>
  © COPYRIGHT 2025 - <a href="https://saniofc.github.io/griffinoria/" target="_blank">saniofc.github.io/griffinoria/</a>
</footer>

<script type="module">
// #############################################################
// ############## MÓDULOS FIREBASE ATUALIZADOS #################
// #############################################################
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"; // Usando 9.23.0 (exemplo)
import { getDatabase, ref, onValue, runTransaction, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// #############################################################
// ################### VARIÁVEIS DE CONFIGURAÇÃO ###################
// #############################################################

// URL base do seu site para retorno do Mercado Pago
const SITE_URL = "https://saniofc.github.io/griffinoria/";

// URL da sua API no RENDER para gerar a preferência de pagamento (MUITO IMPORTANTE!)
// ******* SUBSTITUA ESTA URL PELA SUA REAL NO RENDER *******
const RENDER_API_URL = "https://SEU-NOME-DO-SERVICO.onrender.com/gerar-preferencia"; 

// Credenciais do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDsrYjO2yVTemKqwmJRzNjh5sfaMalPqhE",
  authDomain: "cliques-4a2c1.firebaseapp.com",
  databaseURL: "https://cliques-4a2c1-default-rtdb.firebaseio.com",
  projectId: "cliques-4a2c1",
  storageBucket: "cliques-4a2c1.firebasestorage.app",
  messagingSenderId: "903875153255",
  appId: "1:903875153255:web:ff3cf25e059b10d665b3c2",
  measurementId: "G-BQHZ7FWRJD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// CHAVE PÚBLICA DO MERCADO PAGO
const MERCADOPAGO_PUBLIC_KEY = "APP_USR-747669d7-f43b-40c3-8b5f-3a496e478245";

// Inicializa Mercado Pago
const mp = new MercadoPago(MERCADOPAGO_PUBLIC_KEY, {
    locale: 'pt-BR'
});

// #############################################################
// ################### VARIÁVEIS DE ELEMENTOS #####################
// #############################################################

const menu = document.getElementById('sideMenu');
const comprarVipBtn = document.getElementById('comprarVipBtn');
const vipModal = document.getElementById('vipModal');
const fecharVipIcon = document.getElementById('fecharVipIcon');
const fecharVipBtn = document.getElementById('fecharVipBtn');
const vipCodeModal = document.getElementById('vipCodeModal');
const vipCodeDisplay = document.getElementById('vipCodeDisplay');
const copyVipCodeBtn = document.getElementById('copyVipCodeBtn');

// #############################################################
// ################### FUNÇÕES VIP CODE #########################
// #############################################################

function showVipCode(code) {
    vipCodeDisplay.textContent = code;
    vipCodeModal.style.display = 'flex';
    // Opcional: Salvar para uso ou exibição posterior
    localStorage.setItem('lastVipCode', code);
}

copyVipCodeBtn.onclick = () => {
    const code = vipCodeDisplay.textContent;
    navigator.clipboard.writeText(code).then(() => {
        copyVipCodeBtn.textContent = 'Copiado! ✅';
        setTimeout(() => copyVipCodeBtn.textContent = 'Copiar Código', 2000);
    }).catch(err => {
        alert("Erro ao copiar. Tente manualmente.");
    });
};

document.getElementById('closeVipCodeModal').onclick = () => vipCodeModal.style.display = 'none';
// Adiciona o fechar para o 'X' e o botão
fecharVipIcon.onclick = () => vipModal.style.display = 'none';
fecharVipBtn.onclick = () => vipModal.style.display = 'none';

// #############################################################
// ################### FUNÇÃO MP RENDERIZAÇÃO ###################
// #############################################################

function renderizarMercadoPago(preferenceId) {
    const container = document.getElementById('mercadopago-button-container');
    container.innerHTML = '';
    
    if (preferenceId.startsWith("TEST-")) {
        container.innerHTML = `<p style="color:yellow; font-weight:bold; font-size:14px;">
            ⚠️ ATENÇÃO: Botão de TESTE. O servidor da API não retornou o ID real. Corrija o backend.
        </p>`;
    }

    mp.checkout({
        preference: {
            id: preferenceId 
        },
        render: {
            container: '#mercadopago-button-container',
            label: '⭐ Pagar R$5,00 (24h VIP)', // Mantém para a opção de 24h
        }
    });
}

// #############################################################
// ############### CHECAGEM DE PAGAMENTO (Callback MP) ###########
// #############################################################

/**
 * Checa os parâmetros de URL após o retorno do Mercado Pago.
 * Na realidade, o backend é quem deve gerar e retornar o código VIP.
 * Esta versão SIMULA essa busca, usando o external_reference.
 */
async function checkPaymentStatus() {
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    const paymentId = urlParams.get('payment_id');
    const externalReference = urlParams.get('external_reference');

    // Limpa a URL imediatamente para evitar reexibir o modal no refresh
    window.history.replaceState({}, document.title, SITE_URL); 

    // 1. O cliente voltou de uma transação APROVADA
    if (status === 'approved' && externalReference) {
        
        // **Ação REAL no seu backend é: 
        // 1. Validar o 'payment_id' para garantir que foi pago.
        // 2. Gerar o Código VIP no banco de dados.
        // 3. Retornar o Código VIP. **
        
        // --- SIMULAÇÃO PARA ESTE FRONTEND ---
        // Aqui estamos simulando que o backend já gerou o código VIP no Firebase.
        try {
            const userRef = ref(db, `usuarios/${externalReference}`);
            const snapshot = await new Promise(resolve => onValue(userRef, resolve, { onlyOnce: true }));
            const userData = snapshot.val();

            if (userData && userData.lastVipCode) {
                 showVipCode(userData.lastVipCode);
                 // Opcional: Remover o código do Firebase após a primeira visualização
                 // remove(ref(db, `usuarios/${externalReference}/lastVipCode`));
            } else {
                 // Fallback (SE SEU BACKEND FALHAR E NÃO SALVAR O CÓDIGO)
                 alert("Pagamento APROVADO! Mas não encontramos seu Código VIP no banco. Entre em contato com o suporte: " + externalReference);
            }
        } catch (error) {
            console.error("Erro ao buscar código VIP no Firebase:", error);
            alert("Pagamento APROVADO! Erro ao buscar código. ID da Transação: " + externalReference);
        }
    }
    
    // 2. O cliente voltou de uma transação PENDENTE ou FALHA
    if (status === 'pending') {
         alert("Pagamento PENDENTE. O Código VIP será liberado após a confirmação do Mercado Pago.");
    }
     if (status === 'failure') {
         alert("Pagamento FALHOU. Tente novamente ou verifique os dados de pagamento.");
    }
}


// #############################################################
// ################### EVENTO COMPRAR VIP #######################
// #############################################################

comprarVipBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  vipModal.style.display = "flex";
  menu.classList.remove("open");

  // 1. Tenta recuperar o ID do usuário ou gera um novo (Seguro com crypto.randomUUID)
  let usuario = localStorage.getItem('usuarioID');
  if (!usuario) {
      // Usa window.crypto.randomUUID() para IDs seguros no frontend (compatível com HTTPS)
      usuario = window.crypto.randomUUID(); 
      localStorage.setItem('usuarioID', usuario); 
  }

  // Fallback: ID de teste
  let preferenceIdReal = "TEST-f463372c-f3e0-40e1-a083-d95b5420377e"; 
  const VALOR_24H = 5.00; // Define o valor para 24h
  
  // URLs de retorno do Mercado Pago. O external_reference é crucial.
  const SUCCESS_URL = SITE_URL + "?status=approved&external_reference=" + usuario;
  const FAILURE_URL = SITE_URL + "?status=failure&external_reference=" + usuario;
  const PENDING_URL = SITE_URL + "?status=pending&external_reference=" + usuario;

  try {
    const response = await fetch(RENDER_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
          valor: VALOR_24H, // Envia o valor escolhido
          external_reference: usuario, // ID único para rastreamento
          back_urls: { 
              success: SUCCESS_URL,
              failure: FAILURE_URL,
              pending: PENDING_URL 
          }
      }) 
    });
    
    if (!response.ok) {
        throw new Error(`Servidor respondeu com erro: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.preferenceId) {
      preferenceIdReal = data.preferenceId; 
    } else {
      console.warn('Backend retornou sucesso, mas sem preferenceId. Usando ID de teste.');
    }
    
  } catch (err) {
    console.error('Falha na comunicação com o backend:', err.message);
    alert('Erro de conexão com o servidor. O botão de pagamento está usando um ID de TESTE.');
  } finally {
    renderizarMercadoPago(preferenceIdReal); 
  }
});


// #############################################################
// ################### INICIALIZAÇÃO ############################
// #############################################################

// (Funções como carregarGrupos, eventos do menu e termos foram omitidas, mas assumidas como existentes)
// carregarGrupos(); // Descomente quando suas funções de grupos estiverem prontas

// ** Chama a checagem de pagamento ao carregar o site **
checkPaymentStatus(); 

// #############################################################
// ################### (OUTRAS FUNÇÕES AQUI) #####################
// #############################################################

// Exemplo de como você pode garantir que o usuário tenha um ID na primeira visita
if (!localStorage.getItem('usuarioID')) {
    localStorage.setItem('usuarioID', window.crypto.randomUUID());
}

</script>
</body>
</html>
